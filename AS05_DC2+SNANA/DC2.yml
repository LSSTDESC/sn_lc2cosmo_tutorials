
GLOBAL:
  CFG_PATH: $SNANA_LSST_ROOT/starterKits/pippin/cfg_lsst_cori.yml
  SBATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 1

#  DATA_DIRS:
#    - $SNANA_DC2_DIR/AS5/cosmomc_templates

ALIAS:
  APPEND_FITRES: &append_fitres
    APPEND_TABLE_VARLIST: RA DEC SNRMAX_u SNRMAX_g SNRMAX_r SNRMAX_i SNRMAX_z SNRMAX_Y FLUXCALMAX_u FLUXCALMAX_g FLUXCALMAX_r FLUXCALMAX_i FLUXCALMAX_z FLUXCALMAX_Y  m0obs_u m0obs_g m0obs_r m0obs_i m0obs_z m0obs_Y TrestMIN TrestMAX T0GAPMAX TGAPMAX TrestRange

  AB_GRID: &ab_grid
    BIASCOR_SALT2ALPHA_GRID: 0.08  0.16
    BIASCOR_SALT2BETA_GRID:  2.5   3.6

DATAPREP:
  DC2_DATA:
    OPTS:
      RAW_DIR: $SNANA_LSST_ROOT/lcmerge/DC2_run22i_FITS
      BLIND: False
      PHOTFLAG_MSKREJ:  0
      OPT_SETPKMJD:    20
      
SIM:
  DC2_BIASCOR:
    IA_SALT2:
      BASE: $SNANA_DC2_DIR/AS2/SIMGEN_LSST_DC2.INPUT
      NGENTOT_LC:  80000     # default is 80k x 40 jobs
      <<: *ab_grid
 
    GLOBAL:
      FORMAT_MASK: 48
      RANSEED_REPEAT: 40 12345
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 40

  DC2_SIMDATA:
    IA:
      BASE: $SNANA_DC2_DIR/AS2/SIMGEN_LSST_DC2.INPUT
      NGENTOT_LC:   2500  # defaut is 2500 x 10 jobs
      SIMGEN_DUMPALL:  SWITCH     
    GLOBAL:
      FORMAT_MASK:  48
      RANSEED_REPEAT: 10 12345
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 10

# ----------------------------------------------------
LCFIT:
  FIT_DATA:
    BASE: $SNANA_DC2_DIR/AS5/LCFIT_TEMPLATE.NML
    MASK: DATA
    FITOPTS: $SNANA_DC2_DIR/AS5/FITOPT_SYST.yml
    OPTS:
      <<: *append_fitres
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 10
      OPT_SNCID_LIST: 1   # use same SNID list for all systematics
      
# fit again for biascor; leave out FITOPTs
  FIT_BIASCOR:
    BASE: $SNANA_DC2_DIR/AS5/LCFIT_TEMPLATE.NML
    MASK: BIASCOR
    OPTS:
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 60
      
AGGREGATION:
  AGG:

MERGE:
  MERGE:

BIASCOR:     # BBC stage
# run BBC in DC2 data
  BBC_DC2DATA:
    BASE: $SNANA_DC2_DIR/AS5/SALT2mu_DC2_BBC5D.INPUT
    DATA: [ FIT_DATA_DC2_DATA ]
    SIMFILE_BIASCOR: [ FIT_BIASCOR_DC2_BIASCOR ]
    OPTS:
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 4
      blindflag: 0

# run BBC on sim data
  BBC_SIMDATA:
    BASE: $SNANA_DC2_DIR/AS5/SALT2mu_DC2_BBC5D.INPUT
    DATA: [ FIT_DATA_DC2_SIMDATA ]
    SIMFILE_BIASCOR: [ FIT_BIASCOR_DC2_BIASCOR ]
    OPTS:
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 4
      blindflag: 0

CREATE_COV:
  LSST_COV:
    MASK: BBC
    OPTS:
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 4
      INI_DIR: $SNANA_DC2_DIR/AS5/cosmomc_templates
      COVOPTS:   #    +FITIOPT, +MUOPT
        - "[NOSYS]  [=DEFAULT,=DEFAULT]" # no syst; stat only
        - "[DC2CAL] [+DC2CAL,=DEFAULT]"  # all FITOPT with DC2CAL in name
        - "[MWEBV]  [=MWEBV,=DEFAULT]"   # only MWEBV syst

# COSMOFIT:
#  CODE: COSMOMC ... or COBAYA
  
COSMOMC:
  SN_BANANA_OMW:
    OPTS:
      BATCH_INFO: sbatch $SBATCH_TEMPLATES/SBATCH_DEFAULT.TEMPLATE 8
      INI:     sn_omw.ini

#COBAYA:

ANALYSE:
  BANANA_OMW:
    MASK_COSMOMC: BANANA_OMW
  DATASIM_OVERLAY:
    MASK_LCFIT:
      - FIT_DATA_DC2_DATA      
      - FIT_DATA_DC2_SIMDATA
